<!DOCTYPE html><html><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description"><title>Spree Extend: Creating Custom Promotion Rule | Sandeep Kumar</title><link rel="stylesheet" type="text/css" href="/css/normalize.css"><link rel="stylesheet" type="text/css" href="/css/highlight.css"><link rel="stylesheet" type="text/css" href="/css/very-simple.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/font-awesome/4.5.0/css/font-awesome.min.css"><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"></head><body><!-- include the sidebar--><!-- include ./includes/sidebar.jade--><!-- Blog title and subtitle--><header><div class="container header"><a id="logo" href="/." class="title">Sandeep Kumar</a><span class="subtitle">Learn . Experiment . Build . Repeat</span><label id="toggle-menu" for="menu" onclick><i class="fa fa-bars"></i></label></div></header><!-- use checkbox hack for toggle nav-bar on small screens--><input id="menu" type="checkbox"><!-- Navigation Links--><nav id="nav"><div class="container"><a href="/" class="sidebar-nav-item active">Home</a><a href="/archives" class="sidebar-nav-item">Archives</a></div></nav><div id="header-margin-bar"></div><!-- gallery that comes before the header--><div class="wrapper"><div class="container post-header"><h1>Spree Extend: Creating Custom Promotion Rule</h1></div></div><div class="wrapper"><div class="container meta"><div class="post-time">2012-07-12</div><div class="post-tags"><a class="post-tag-link" href="/tags/rails/">rails</a>/<a class="post-tag-link" href="/tags/spree/">spree</a>/<a class="post-tag-link" href="/tags/spree-extend/">spree extend</a></div></div></div><article><div class="container post"><p>I’m working on an E-commerce website for sometime now. We are usingi <a href="http://spreecommerce.com/" target="_blank" rel="external">spree</a> as backbone of the project and customizing where and when its required. Spree is quite good and fully functioning E-commerce Rails engine which give you base to build a e-commerce website quickly and with lesser efforts.</p>
<p>One of the main features of any e-commerce website is Promotions/Coupons. Spree also has a built in spree promotion module which is ready to use with predefined rules and adjustment calculators. Being an ADMIN I can define any new promotion rules i.e. first order, user specific, products specific etc. Also I can define the actions like ALL or ANY. You can have a look on spree_promo module at <a href="https://github.com/spree/spree/tree/master/promo" target="_blank" rel="external">spree_promo</a> and see how it works.</p>
<p>Spree already provides some 4-5 predefined Promotions Rules on the basis of which every order get cross-checked whether some adjustments has to be done or not. Most of the time these rules/calculators are more than enough in general usage, but sometimes we need few very specific CUSTOM rules to be defined. Here I’m going to explain how easy it is to create new spree promotion rules.</p>
<h4 id="Create-Promotion-Rule"><a href="#Create-Promotion-Rule" class="headerlink" title="Create Promotion Rule"></a>Create Promotion Rule</h4><ol>
<li>create a model file app/models/spree/promotion/rules/my_custom_promotion.rb</li>
</ol>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">module Spree</div><div class="line">  class Promotion::Rules::MyCustomPromotion &amp;lt; PromotionRule</div><div class="line">    // required associations or preferences if any</div><div class="line">    // required attribute accessible if you need to protect some attributes from mass assignment</div><div class="line">    // match polices and operators</div><div class="line">    MATCH_POLICIES = %w(any all) // as per your requirement</div><div class="line">    def eligible?(order, options=&#123;&#125;)</div><div class="line">      // This method is the place where every order is being verified whether its eligible for any promotional discount</div><div class="line">    end</div><div class="line">  end</div><div class="line">end</div></pre></td></tr></table></figure>
<ol>
<li>Add this custom promotion rule to default spree promotion rules list. Write the following code in either <code>application.rb</code> or some initializer</li>
</ol>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">initializer <span class="string">"spree.promo.register.promotions.rules"</span> <span class="keyword">do</span> <span class="params">|app|</span></div><div class="line">  app.config.spree.promotions.rules += [Spree::Promotion::Rules::MyCustomPromotion]</div><div class="line"><span class="keyword">end</span></div></pre></td></tr></table></figure>
<ol>
<li>Add the translations for name &amp; description for custom rule as spree use the standard view for all with Translation method <code>t(&#39;name&#39;)</code> or <code>t(&#39;description&#39;)</code>. Write the following code in your <code>config/locales/en.yml</code> (or any other locale file if you are having multilingual products).</li>
</ol>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="attr">en:</span></div><div class="line"><span class="attr">  promotion_rule_types:</span></div><div class="line"><span class="attr">    product_by_tag:</span></div><div class="line"><span class="attr">      name:</span> Products By MyCustomPromotion</div><div class="line"><span class="attr">      description:</span> Add products from MyCustomPromotion</div></pre></td></tr></table></figure>
<ol>
<li>Create the view partial file for the custom promotion rule. Add a file <code>app/admin/promotions/rules/_my_custom_promotion.html.erb</code> or haml or something else depending on the template engine you are using for views. And, restart your application server and you are good to go. Now whenever you are going to edit the Promotion, in the promotions rules list you will see you custom rule also available.</li>
</ol>
<ul>
<li>if you want some custom price adjustments/calculations as well, then you have to create a new calculator. E.g. If I want to define some flat percentage benefit on my custom promotion we have to create <code>app/models/spree/calculator/flat_percentage.rb</code></li>
</ul>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">module Spree</div><div class="line">  class Calculator::FlatPercetange &amp;lt; Calculator</div><div class="line">    // preferences if there are any.</div><div class="line">    // attributes accessibles</div><div class="line">    def compute(object)</div><div class="line">      // main method where we have to compute the adjustments we have to made.</div><div class="line">    end</div><div class="line">  end</div><div class="line">end</div></pre></td></tr></table></figure>
<p>I hope it helped someone. In case of any query, please feel free to ask here or drop me a mail at <a href="mailto:skr.ymca@gmail.com?subject=Re:Creating custom spree promotion rule" target="_blank" rel="external">Sandeep Kumar</a></p>
</div><!-- comment system--><div class="container"><hr></div></article><footer id="footer"><div class="container"><div class="bar"><div class="social"><a href="/atom.xml" target="_blank"><i class="fa fa-rss"></i></a></div><div class="footer">© 2016 <a href="/" rel="nofollow">Sandeep Kumar</a>. Powered by <a rel="nofollow" target="_blank" href="https://hexo.io">Hexo</a>. Theme <a target="_blank" href="https://github.com/lotabout/very-simple">very-simple</a>.</div></div></div></footer><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/fancybox/2.1.5/jquery.fancybox.css"><script src="//cdn.bootcss.com/jquery/2.0.3/jquery.min.js"></script><script src="//cdn.bootcss.com/fancybox/2.1.5/jquery.fancybox.pack.js"></script><script>$(document).ready(function() {
    $(".fancybox").fancybox();
});
</script></body></html>