<!DOCTYPE html><html><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description"><title>Spree Extend: Updating eligibility criteria for any existing promotion rule | Sandeep Kumar</title><link rel="stylesheet" type="text/css" href="/css/normalize.css"><link rel="stylesheet" type="text/css" href="/css/highlight.css"><link rel="stylesheet" type="text/css" href="/css/very-simple.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/font-awesome/4.5.0/css/font-awesome.min.css"><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"></head><body><!-- include the sidebar--><!-- include ./includes/sidebar.jade--><!-- Blog title and subtitle--><header><div class="container header"><a id="logo" href="/." class="title">Sandeep Kumar</a><span class="subtitle">Learn . Experiment . Build . Repeat</span><label id="toggle-menu" for="menu" onclick><i class="fa fa-bars"></i></label></div></header><!-- use checkbox hack for toggle nav-bar on small screens--><input id="menu" type="checkbox"><!-- Navigation Links--><nav id="nav"><div class="container"><a href="/" class="sidebar-nav-item active">Home</a><a href="/archives" class="sidebar-nav-item">Archives</a></div></nav><div id="header-margin-bar"></div><!-- gallery that comes before the header--><div class="wrapper"><div class="container post-header"><h1>Spree Extend: Updating eligibility criteria for any existing promotion rule</h1></div></div><div class="wrapper"><div class="container meta"><div class="post-time">2012-07-19</div><div class="post-tags"><a class="post-tag-link" href="/tags/rails/">rails</a>/<a class="post-tag-link" href="/tags/spree/">spree</a></div></div></div><article><div class="container post"><p>As I mentioned in my last post <a href="http://whatpeoplethink.wordpress.com/2012/07/12/spree-extend-creating-custom-promotion-rule/" target="_blank" rel="external">spree-extend</a>, how to create custom promotion rule(s) while working with Spree based e-Commerece website. Last weekend, I faced a situation where I need to update the existing promotion rule to handle some specific condition.</p>
<h3 id="Scenario"><a href="#Scenario" class="headerlink" title="Scenario"></a>Scenario</h3><p>For example, when I select “Product(s)” spree default rule, it gives us the option to choose products manually or choose by product group and its working as expected. Later, my client told me he wants, when he selects by product_group he can actually select some Taxons/Tags so that only the products belongs to that product_group and has taxon(s) listed there are eligible for this promotion.</p>
<h3 id="Solution"><a href="#Solution" class="headerlink" title="Solution"></a>Solution</h3><p>For updating any existing promotion rules in spree there are few generic steps we need to follow,</p>
<ul>
<li>Extend the corresponding spree-&gt;promotion-&gt;rules model class. Here, I created a file <code>app/models/promotion/rules/product_decorator.rb</code></li>
</ul>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">Promotion::Rules::Product.class_eval <span class="keyword">do</span></div><div class="line"><span class="keyword">end</span></div></pre></td></tr></table></figure>
<ul>
<li>Create the attribute accessors/ accessibles for new attributes you needed.</li>
</ul>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">Promotion::Rules::Product.class_eval do</div><div class="line">  has_and_belongs_to_many :taxons, class_name: "::taxon", join_table: "taxons_promotion_rules", foreign_key: "promotion_rule_id"</div><div class="line">  attr_accessible :taxon_ids_string</div><div class="line">  //setter and getter methods</div><div class="line">  def taxon_ids_string</div><div class="line">    self.taxon_ids.join(",")</div><div class="line">  end</div><div class="line">  def taxon_ids_string=(string)</div><div class="line">    self.taxon_ids = string.split(",").map(&amp;:strip)</div><div class="line">  end</div><div class="line">end</div></pre></td></tr></table></figure>
<ul>
<li>update the corresponding View file for the same rule in admin/promotions/rules/_product.html.haml or .erb if you are using erb. Add the required code for handling the same. In My case I added one TokenInput object to get multiple taxons selection. Add code something like this… where-ever you think is more suitable for you.</li>
</ul>
<figure class="highlight haml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="tag">%<span class="selector-tag">p</span>&#123;<span class="attr">:class</span>=&gt;<span class="string">"field products_rule_taxons"</span>&#125;</span></div><div class="line"><span class="tag">  %<span class="selector-tag">label</span></span></div><div class="line">    =<span class="ruby"> <span class="string">"Choose Taxons"</span></span></div><div class="line">    =<span class="ruby"> taxon_picker_field <span class="string">"<span class="subst">#&#123;param_prefix&#125;</span>[tag_ids_string]"</span>, promotion_rule.taxon_ids_string</span></div></pre></td></tr></table></figure>
<p>There are 2 different ways of adding this to view file. One, you can write a decorator and tell before/after which object you want to put this code. Second, you can re-write the complete file and do whatever you need. Upto you.</p>
<p>Also, <code>taxon_picker_field</code> is a helper method which I created for creating the <code>tokenInput/tokenizer</code> object. Create the <code>AdminBaseHelper</code> decorator file, if not exists and put the following code or something like that,</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">Admin::BaseHelper.module_eval <span class="keyword">do</span></div><div class="line">  <span class="function"><span class="keyword">def</span> <span class="title">taxon_picker_field</span><span class="params">(name, value)</span></span></div><div class="line">    taxons = value == <span class="string">""</span> ?  [] : Taxon.where(<span class="string">"id in ('<span class="subst">#&#123;value&#125;</span>')"</span>)</div><div class="line">    taxon_names_hash = taxons.inject(&#123;&#125;)&#123;<span class="params">|memo,item|</span> memo[item.id] = item.name; memo&#125;</div><div class="line">    <span class="string">%(tag_picker_initializer()</span>;).html_safe</div><div class="line">  <span class="keyword">end</span></div><div class="line"><span class="keyword">end</span></div></pre></td></tr></table></figure>
<ul>
<li>Update the eligible? and/or eligible_products methods as per your rule updations. Here in my case I just need to change the eligible_products method. Add the following code in <code>app/models/promotion/rules/product_decorator.rb</code></li>
</ul>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">eligible_products</span></span></div><div class="line">  <span class="keyword">if</span> product_group</div><div class="line">    <span class="keyword">return</span> <span class="keyword">self</span>.taxons.collect(&amp;amp;<span class="symbol">:products</span>).flatten</div><div class="line">  <span class="keyword">end</span></div><div class="line">  products</div><div class="line"><span class="keyword">end</span></div></pre></td></tr></table></figure>
<p>Or something like that as per your requirements</p>
<p>And yes, We are good to go and the new rule criteria will be applied from now on-wards. Good luck, In case of any query, feel free to ask here or email me at <a href="mailto:skr.ymca@gmail.com" target="_blank" rel="external">Sandeep Kumar</a></p>
</div><!-- comment system--><div class="container"><hr></div></article><footer id="footer"><div class="container"><div class="bar"><div class="social"><a href="/atom.xml" target="_blank"><i class="fa fa-rss"></i></a></div><div class="footer">© 2016 <a href="/" rel="nofollow">Sandeep Kumar</a>. Powered by <a rel="nofollow" target="_blank" href="https://hexo.io">Hexo</a>. Theme <a target="_blank" href="https://github.com/lotabout/very-simple">very-simple</a>.</div></div></div></footer><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/fancybox/2.1.5/jquery.fancybox.css"><script src="//cdn.bootcss.com/jquery/2.0.3/jquery.min.js"></script><script src="//cdn.bootcss.com/fancybox/2.1.5/jquery.fancybox.pack.js"></script><script>$(document).ready(function() {
    $(".fancybox").fancybox();
});
</script></body></html>