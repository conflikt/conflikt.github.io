<!DOCTYPE html><html><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description"><title>Assets &amp; Database hosting on Amazon/S3 | Sandeep Kumar</title><link rel="stylesheet" type="text/css" href="/css/normalize.css"><link rel="stylesheet" type="text/css" href="/css/highlight.css"><link rel="stylesheet" type="text/css" href="/css/very-simple.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/font-awesome/4.5.0/css/font-awesome.min.css"><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"></head><body><!-- include the sidebar--><!-- include ./includes/sidebar.jade--><!-- Blog title and subtitle--><header><div class="container header"><a id="logo" href="/." class="title">Sandeep Kumar</a><span class="subtitle">Learn . Experiment . Build . Repeat</span><label id="toggle-menu" for="menu" onclick><i class="fa fa-bars"></i></label></div></header><!-- use checkbox hack for toggle nav-bar on small screens--><input id="menu" type="checkbox"><!-- Navigation Links--><nav id="nav"><div class="container"><a href="/" class="sidebar-nav-item active">Home</a><a href="/archives" class="sidebar-nav-item">Archives</a></div></nav><div id="header-margin-bar"></div><!-- gallery that comes before the header--><div class="wrapper"><div class="container post-header"><h1>Assets &amp; Database hosting on Amazon/S3</h1></div></div><div class="wrapper"><div class="container meta"><div class="post-time">2011-02-16</div><div class="post-tags"><a class="post-tag-link" href="/tags/S3/">S3</a>/<a class="post-tag-link" href="/tags/assets-hosting/">assets hosting</a>/<a class="post-tag-link" href="/tags/rails/">rails</a></div></div></div><article><div class="container post"><h2 id="Assets-Hosting"><a href="#Assets-Hosting" class="headerlink" title="Assets Hosting"></a>Assets Hosting</h2><p>Lately I was working on a project, highly data driven. Its a movie social network, means there are lots of assets, Photos, Audios &amp; videos. Thats why we should keep continuous backup for our data on some 3rd party provider or somewhere else, which is easier to manage. We are using Amazon::S3 module for our assets and database backup.</p>
<h3 id="Database-Backup"><a href="#Database-Backup" class="headerlink" title="Database Backup"></a>Database Backup</h3><p>For database backup on S3 we used a ruby gem named “mysql_s3_backup”, a simple backup script for mysql and s3 with incremental backups. Before starting the backups, Create a YAML config file:</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line"><span class="attr">mysql:</span></div><div class="line">  <span class="comment"># Database name to backup</span></div><div class="line"><span class="attr">  database:</span> xyz_development</div><div class="line">  <span class="comment"># Mysql user and password to execute commands</span></div><div class="line"><span class="attr">  user:</span> dbuser</div><div class="line"><span class="attr">  password:</span> paswword</div><div class="line">  <span class="comment"># Path to mysql binaries, like mysql, mysqldump (optional)</span></div><div class="line"><span class="attr">  bin_path:</span> /usr/bin/</div><div class="line">  <span class="comment"># Path to the binary logs, should match the bin_log option in your my.cnf</span></div><div class="line"><span class="attr">  bin_log:</span> /var/lib/mysql/binlog/mysql-bin</div><div class="line"><span class="attr">s3:</span></div><div class="line">  <span class="comment"># S3 bucket name to backup to</span></div><div class="line"><span class="attr">  bucket:</span> bucketname</div><div class="line">  <span class="comment"># S3 credentials</span></div><div class="line"><span class="attr">  access_key_id:</span> XXXXXXXXXXXXXXX</div><div class="line"><span class="attr">  secret_access_key:</span> XXXXXXXXXXXXXXXXXXXXXX</div></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="string">"Create a full backup:</span></div><div class="line">mysql_s3_backup -c=your_config.yml full</div><div class="line">"Create an incremental backup:</div><div class="line">mysql_s3_backup -c=your_config.yml inc</div><div class="line"><span class="string">"Restore the latest backup (applying incremental backups):</span></div><div class="line">mysql_s3_backup -c=your_config.yml restore</div><div class="line">"Restore a specific backup (NOT applying incremental backups):</div><div class="line">mysql_s3_backup -c=your_config.yml restore 20091126112233</div></pre></td></tr></table></figure>
<p>We were planning to just keep backup for last 5 copies of the database. So, I did a tweak in the code, and written one wrapper class over the GEM for storing only last 5 backups [in case of full backups only].</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">require</span> <span class="string">'mysql_s3_backup'</span></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">MysqlS3Dumper</span>    </span></div><div class="line">  <span class="keyword">attr_accessor</span> <span class="symbol">:config</span></div><div class="line">  <span class="class"><span class="keyword">class</span> <span class="title">MysqlS3Backup::Backup</span></span></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">full</span><span class="params">(name=make_new_name)</span></span></div><div class="line">      lock <span class="keyword">do</span></div><div class="line">        <span class="comment"># When the full backup runs it delete any binary log files that might already exist</span></div><div class="line">        <span class="comment"># in the bucket. Otherwise the restore will try to restore them even though they’re</span></div><div class="line">        <span class="comment"># older than the full backup.</span></div><div class="line">        @bucket.delete_all @bin_log_prefix</div><div class="line">        with_temp_file <span class="keyword">do</span> <span class="params">|file|</span></div><div class="line">          puts file</div><div class="line">          @mysql.dump(file)</div><div class="line">          @bucket.store(dump_file_name(name), file)</div><div class="line">          @bucket.copy(dump_file_name(name), dump_file_name(<span class="string">"latest"</span>))</div><div class="line">          @bucket.keep_last_five</div><div class="line">        <span class="keyword">end</span></div><div class="line">      <span class="keyword">end</span></div><div class="line">    <span class="keyword">end</span></div><div class="line">  <span class="keyword">end</span></div><div class="line"></div><div class="line">  <span class="class"><span class="keyword">class</span> <span class="title">MysqlS3Backup::Bucket</span></span></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">keep_last_five</span></span></div><div class="line">      puts @name</div><div class="line">      puts <span class="string">"coming to bucket"</span></div><div class="line">      all_backups = AWS::S3::Bucket.objects(@name)</div><div class="line">      <span class="keyword">while</span> all_backups.count &amp;gt; <span class="number">6</span></div><div class="line">        AWS::S3::Bucket.objects(@name).first.delete</div><div class="line">        all_backups = AWS::S3::Bucket.objects(@name)</div><div class="line">      <span class="keyword">end</span></div><div class="line">    <span class="keyword">end</span></div><div class="line">  <span class="keyword">end</span></div><div class="line"></div><div class="line">  <span class="function"><span class="keyword">def</span> <span class="title">initialize</span></span></div><div class="line">    @config = MysqlS3Backup::Config.from_yaml_file(File.dirname(__FILE_<span class="number">_</span>) + <span class="string">"/../config/s3_mysql.yml"</span>)</div><div class="line">  <span class="keyword">end</span></div><div class="line"></div><div class="line"><span class="keyword">end</span></div></pre></td></tr></table></figure>
<h3 id="Assets-Backup"><a href="#Assets-Backup" class="headerlink" title="Assets Backup"></a>Assets Backup</h3><p>For assets backup we use S3Backup ruby gem. S3Backup, is a backup tool to local directory to Amazon S3. It uploads local directory to Amazon S3 with compression. If directories isn’t modified after prior backup,those aren’t upload. It can be Cryptnize upload files if password and salt are configured. To use remotebackup,you should prepare backup configuration file by yaml such below:</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line"><span class="attr">bucket:</span> <span class="string">"bucket name"</span></div><div class="line"><span class="attr">directories:</span></div><div class="line"><span class="bullet">  -</span> <span class="string">"absolute path to directory for backup/restore"</span></div><div class="line"><span class="bullet">  -</span> <span class="string">"iterate directory as you like"</span></div><div class="line"><span class="attr">access_key_id:</span> <span class="string">'Amazon access_key_id'</span></div><div class="line"><span class="attr">secret_access_key:</span> <span class="string">'Amazon secret_access_key'</span></div><div class="line"><span class="attr">password:</span> <span class="string">'password for aes. (optional)'</span></div><div class="line"><span class="attr">salt:</span> <span class="string">'HexString(16 length) (must when password is specified)'</span></div><div class="line"><span class="attr">buffer_size:</span> <span class="string">'number of byte max 50000000000 (optional default 32000000)'</span></div><div class="line"><span class="attr">max_retry_count:</span> <span class="string">'number of retry of post if post failed.(optional default 10)'</span></div><div class="line"><span class="attr">proxy_host:</span> proxy host address if you use proxy.</div><div class="line"><span class="attr">proxy_port:</span> proxy port if you use proxy.</div><div class="line"><span class="attr">proxy_user:</span> login name for proxy server if you use proxy.</div><div class="line"><span class="attr">proxy_password:</span> login password for proxy server if you use proxy.</div><div class="line"><span class="attr">log_level:</span> <span class="string">'output log level. value is debug or info or warn or error(optional default info)'</span></div><div class="line"><span class="attr">temporary:</span> <span class="string">'temporary directory path. default(/tmp)</span></div></pre></td></tr></table></figure>
<ul>
<li>If directories isn’t specified when restore, it restores all directories in bucket.</li>
</ul>
<h4 id="Commands"><a href="#Commands" class="headerlink" title="Commands"></a>Commands</h4><p><strong>backup</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">s3backup [<span class="_">-f</span> configuration file] [-v verbose message] [<span class="_">-l</span> path <span class="keyword">for</span> <span class="built_in">log</span>] [-h <span class="built_in">help</span>]</div><div class="line">configuration file  path to file written above contents. default is ./backup.yml</div><div class="line">verbose             display directory tree and difference of anterior backup</div><div class="line">path <span class="keyword">for</span> <span class="built_in">log</span>        defaut starndard output.</div><div class="line"><span class="built_in">help</span>                <span class="built_in">help</span> message</div></pre></td></tr></table></figure>
<p><strong>restore</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">s3backup -r [<span class="_">-f</span> configuration file] [-v verbose message] [<span class="_">-l</span> path <span class="keyword">for</span> <span class="built_in">log</span>] [-o output dir] [-h <span class="built_in">help</span>]</div><div class="line">configuration file  path to file written above contents. default is ./backup.yml</div><div class="line">verbose             display directory tree and difference of anterior backup</div><div class="line">path <span class="keyword">for</span> <span class="built_in">log</span>        defaut starndard output.</div><div class="line">output dir          path to directory <span class="keyword">for</span> restore directory. defaut is .</div><div class="line"><span class="built_in">help</span>                <span class="built_in">help</span> message</div></pre></td></tr></table></figure>
</div><!-- comment system--><div class="container"><hr></div></article><footer id="footer"><div class="container"><div class="bar"><div class="social"><a href="/atom.xml" target="_blank"><i class="fa fa-rss"></i></a></div><div class="footer">© 2016 <a href="/" rel="nofollow">Sandeep Kumar</a>. Powered by <a rel="nofollow" target="_blank" href="https://hexo.io">Hexo</a>. Theme <a target="_blank" href="https://github.com/lotabout/very-simple">very-simple</a>.</div></div></div></footer><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/fancybox/2.1.5/jquery.fancybox.css"><script src="//cdn.bootcss.com/jquery/2.0.3/jquery.min.js"></script><script src="//cdn.bootcss.com/fancybox/2.1.5/jquery.fancybox.pack.js"></script><script>$(document).ready(function() {
    $(".fancybox").fancybox();
});
</script></body></html>