<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <title>assets &amp; database hosting on amazon/s3 | Sandeep Kumar</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  
  <meta name="keywords" content="railsassets hostingS3" />
  
  
  
  
    <meta name="360-site-verification" content="[object Object]" />
  
  <meta name="description" content="Lately I was working on a project, highly data driven. Its a movie social network, means there are lots of assets, Photos, Audios &amp;amp; videos. Thats why we should keep continuous backup for our data">
<meta property="og:type" content="article">
<meta property="og:title" content="Assets & Database hosting on Amazon/S3">
<meta property="og:url" content="http://r3bo0t.github.io/2011/02/16/assets-database-hosting-on-amazons3/index.html">
<meta property="og:site_name" content="Sandeep Kumar">
<meta property="og:description" content="Lately I was working on a project, highly data driven. Its a movie social network, means there are lots of assets, Photos, Audios &amp;amp; videos. Thats why we should keep continuous backup for our data">
<meta property="og:updated_time" content="2016-12-28T12:57:06.053Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Assets & Database hosting on Amazon/S3">
<meta name="twitter:description" content="Lately I was working on a project, highly data driven. Its a movie social network, means there are lots of assets, Photos, Audios &amp;amp; videos. Thats why we should keep continuous backup for our data">
  
    <link rel="alternate" href="/atom.xml" title="Sandeep Kumar" type="application/atom+xml">
  
  <link rel="icon" href="/css/images/favicon.ico">
  
    <link href="//fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet" type="text/css">
  
  <link href="https://fonts.googleapis.com/css?family=Open+Sans|Montserrat:700" rel="stylesheet" type="text/css">
  <link href="https://fonts.googleapis.com/css?family=Roboto:400,300,300italic,400italic" rel="stylesheet" type="text/css">
  <link href="//cdn.bootcss.com/font-awesome/4.6.3/css/font-awesome.min.css" rel="stylesheet">
  <style type="text/css">
    @font-face{font-family:futura-pt;src:url(https://use.typekit.net/af/9749f0/00000000000000000001008f/27/l?subset_id=2&fvd=n5) format("woff2");font-weight:500;font-style:normal;}
    @font-face{font-family:futura-pt;src:url(https://use.typekit.net/af/90cf9f/000000000000000000010091/27/l?subset_id=2&fvd=n7) format("woff2");font-weight:500;font-style:normal;}
    @font-face{font-family:futura-pt;src:url(https://use.typekit.net/af/8a5494/000000000000000000013365/27/l?subset_id=2&fvd=n4) format("woff2");font-weight:lighter;font-style:normal;}
    @font-face{font-family:futura-pt;src:url(https://use.typekit.net/af/d337d8/000000000000000000010095/27/l?subset_id=2&fvd=i4) format("woff2");font-weight:400;font-style:italic;}</style>
    
  <link rel="stylesheet" id="athemes-headings-fonts-css" href="//fonts.googleapis.com/css?family=Yanone+Kaffeesatz%3A200%2C300%2C400%2C700&amp;ver=4.6.1" type="text/css" media="all">
  <link rel="stylesheet" href="/css/style.css">

  <script src="/js/jquery-3.1.1.min.js"></script>

  <!-- Bootstrap core CSS -->
  <link rel="stylesheet" href="/css/bootstrap.css" >
  <link rel="stylesheet" href="/css/hiero.css" >
  <link rel="stylesheet" href="/css/glyphs.css" >

</head>

<body>
  <header id="allheader" class="site-header" role="banner">
  <div class="clearfix container">
      <div class="site-branding">

          <h1 class="site-title">
            <a href="/" title="Sandeep Kumar" rel="home">
              Sandeep Kumar</a>
          </h1>
          <div class="site-description">Learn . Experiment . Build . Repeat</div>

            
          <nav id="main-navigation" class="main-navigation" role="navigation">
            <a class="nav-open">Menu</a>
            <a class="nav-close">Close</a>
            <div class="clearfix sf-menu">

              <ul id="main-nav" class="nmenu sf-js-enabled">
                    
                      <li class="menu-item menu-item-type-custom menu-item-object-custom menu-item-home menu-item-1663"> <a class="" href="/">Home</a> </li>
                    
                      <li class="menu-item menu-item-type-custom menu-item-object-custom menu-item-home menu-item-1663"> <a class="" href="/archives">Archives</a> </li>
                    
                      <li class="menu-item menu-item-type-custom menu-item-object-custom menu-item-home menu-item-1663"> <a class="" href="/categories">Categories</a> </li>
                    
                      <li class="menu-item menu-item-type-custom menu-item-object-custom menu-item-home menu-item-1663"> <a class="" href="/tags">Tags</a> </li>
                    
                      <li class="menu-item menu-item-type-custom menu-item-object-custom menu-item-home menu-item-1663"> <a class="" href="/about">About</a> </li>
                    
              </ul>
            </div>
          </nav>


      </div>
  </div>
</header>


  <div style="background:#fff;width: 100%;">

      <div style="max-height:600px; overflow: hidden;">
        <img width="100%" alt="Hike News" src="/css/images/pose.jpg">
      </div>

  </div>



  <div id="container">
    <div id="wrap">
            
      <div id="content" class="outer">
        
          <section id="main" style="float:none;"><article id="post-assets-database-hosting-on-amazons3" style="width: 66%; float:left;" class="article article-type-post" itemscope itemprop="blogPost" >
  <div id="articleInner" class="clearfix post-1016 post type-post status-publish format-standard has-post-thumbnail hentry category-template-2 category-uncategorized tag-codex tag-edge-case tag-featured-image tag-image tag-template">
    
    
      <header class="article-header">
        
  
    <h1 class="thumb" class="article-title" itemprop="name">
      Assets &amp; Database hosting on Amazon/S3
    </h1>
  

      </header>
    
    <div class="article-meta">
      
	Posted on <a href="/2011/02/16/assets-database-hosting-on-amazons3/" class="article-date">
	  <time datetime="2011-02-15T18:30:00.000Z" itemprop="datePublished">February 16, 2011</time>
	</a>

    </div>
    <div class="article-entry" itemprop="articleBody">
      
        <p>Lately I was working on a project, highly data driven. Its a movie social network, means there are lots of assets, Photos, Audios &amp; videos. Thats why we should keep continuous backup for our data on some 3rd party provider or somewhere else, which is easier to manage. We are using Amazon::S3 module for our assets and database backup.</p>
<h3 id="Database-Backup"><a href="#Database-Backup" class="headerlink" title="Database Backup"></a>Database Backup</h3><p>For database backup on S3 we used a ruby gem named “mysql_s3_backup”, a simple backup script for mysql and s3 with incremental backups. Before starting the backups, Create a YAML config file:</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line"><span class="attr">mysql:</span></div><div class="line">  <span class="comment"># Database name to backup</span></div><div class="line"><span class="attr">  database:</span> xyz_development</div><div class="line">  <span class="comment"># Mysql user and password to execute commands</span></div><div class="line"><span class="attr">  user:</span> dbuser</div><div class="line"><span class="attr">  password:</span> paswword</div><div class="line">  <span class="comment"># Path to mysql binaries, like mysql, mysqldump (optional)</span></div><div class="line"><span class="attr">  bin_path:</span> /usr/bin/</div><div class="line">  <span class="comment"># Path to the binary logs, should match the bin_log option in your my.cnf</span></div><div class="line"><span class="attr">  bin_log:</span> /var/lib/mysql/binlog/mysql-bin</div><div class="line"><span class="attr">s3:</span></div><div class="line">  <span class="comment"># S3 bucket name to backup to</span></div><div class="line"><span class="attr">  bucket:</span> bucketname</div><div class="line">  <span class="comment"># S3 credentials</span></div><div class="line"><span class="attr">  access_key_id:</span> XXXXXXXXXXXXXXX</div><div class="line"><span class="attr">  secret_access_key:</span> XXXXXXXXXXXXXXXXXXXXXX</div></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="string">"Create a full backup:</span></div><div class="line">mysql_s3_backup -c=your_config.yml full</div><div class="line">"Create an incremental backup:</div><div class="line">mysql_s3_backup -c=your_config.yml inc</div><div class="line"><span class="string">"Restore the latest backup (applying incremental backups):</span></div><div class="line">mysql_s3_backup -c=your_config.yml restore</div><div class="line">"Restore a specific backup (NOT applying incremental backups):</div><div class="line">mysql_s3_backup -c=your_config.yml restore 20091126112233</div></pre></td></tr></table></figure>
<p>We were planning to just keep backup for last 5 copies of the database. So, I did a tweak in the code, and written one wrapper class over the GEM for storing only last 5 backups [in case of full backups only].</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">require</span> <span class="string">'mysql_s3_backup'</span></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">MysqlS3Dumper</span>    </span></div><div class="line">  <span class="keyword">attr_accessor</span> <span class="symbol">:config</span></div><div class="line">  <span class="class"><span class="keyword">class</span> <span class="title">MysqlS3Backup::Backup</span></span></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">full</span><span class="params">(name=make_new_name)</span></span></div><div class="line">      lock <span class="keyword">do</span></div><div class="line">        <span class="comment"># When the full backup runs it delete any binary log files that might already exist</span></div><div class="line">        <span class="comment"># in the bucket. Otherwise the restore will try to restore them even though they’re</span></div><div class="line">        <span class="comment"># older than the full backup.</span></div><div class="line">        @bucket.delete_all @bin_log_prefix</div><div class="line">        with_temp_file <span class="keyword">do</span> <span class="params">|file|</span></div><div class="line">          puts file</div><div class="line">          @mysql.dump(file)</div><div class="line">          @bucket.store(dump_file_name(name), file)</div><div class="line">          @bucket.copy(dump_file_name(name), dump_file_name(<span class="string">"latest"</span>))</div><div class="line">          @bucket.keep_last_five</div><div class="line">        <span class="keyword">end</span></div><div class="line">      <span class="keyword">end</span></div><div class="line">    <span class="keyword">end</span></div><div class="line">  <span class="keyword">end</span></div><div class="line"></div><div class="line">  <span class="class"><span class="keyword">class</span> <span class="title">MysqlS3Backup::Bucket</span></span></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">keep_last_five</span></span></div><div class="line">      puts @name</div><div class="line">      puts <span class="string">"coming to bucket"</span></div><div class="line">      all_backups = AWS::S3::Bucket.objects(@name)</div><div class="line">      <span class="keyword">while</span> all_backups.count &amp;gt; <span class="number">6</span></div><div class="line">        AWS::S3::Bucket.objects(@name).first.delete</div><div class="line">        all_backups = AWS::S3::Bucket.objects(@name)</div><div class="line">      <span class="keyword">end</span></div><div class="line">    <span class="keyword">end</span></div><div class="line">  <span class="keyword">end</span></div><div class="line"></div><div class="line">  <span class="function"><span class="keyword">def</span> <span class="title">initialize</span></span></div><div class="line">    @config = MysqlS3Backup::Config.from_yaml_file(File.dirname(__FILE_<span class="number">_</span>) + <span class="string">"/../config/s3_mysql.yml"</span>)</div><div class="line">  <span class="keyword">end</span></div><div class="line"></div><div class="line"><span class="keyword">end</span></div></pre></td></tr></table></figure>
<h3 id="Assets-Backup"><a href="#Assets-Backup" class="headerlink" title="Assets Backup"></a>Assets Backup</h3><p>For assets backup we use S3Backup ruby gem. S3Backup, is a backup tool to local directory to Amazon S3. It uploads local directory to Amazon S3 with compression. If directories isn’t modified after prior backup,those aren’t upload. It can be Cryptnize upload files if password and salt are configured. To use remotebackup,you should prepare backup configuration file by yaml such below:</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line"><span class="attr">bucket:</span> <span class="string">"bucket name"</span></div><div class="line"><span class="attr">directories:</span></div><div class="line"><span class="bullet">  -</span> <span class="string">"absolute path to directory for backup/restore"</span></div><div class="line"><span class="bullet">  -</span> <span class="string">"iterate directory as you like"</span></div><div class="line"><span class="attr">access_key_id:</span> <span class="string">'Amazon access_key_id'</span></div><div class="line"><span class="attr">secret_access_key:</span> <span class="string">'Amazon secret_access_key'</span></div><div class="line"><span class="attr">password:</span> <span class="string">'password for aes. (optional)'</span></div><div class="line"><span class="attr">salt:</span> <span class="string">'HexString(16 length) (must when password is specified)'</span></div><div class="line"><span class="attr">buffer_size:</span> <span class="string">'number of byte max 50000000000 (optional default 32000000)'</span></div><div class="line"><span class="attr">max_retry_count:</span> <span class="string">'number of retry of post if post failed.(optional default 10)'</span></div><div class="line"><span class="attr">proxy_host:</span> proxy host address if you use proxy.</div><div class="line"><span class="attr">proxy_port:</span> proxy port if you use proxy.</div><div class="line"><span class="attr">proxy_user:</span> login name for proxy server if you use proxy.</div><div class="line"><span class="attr">proxy_password:</span> login password for proxy server if you use proxy.</div><div class="line"><span class="attr">log_level:</span> <span class="string">'output log level. value is debug or info or warn or error(optional default info)'</span></div><div class="line"><span class="attr">temporary:</span> <span class="string">'temporary directory path. default(/tmp)</span></div></pre></td></tr></table></figure>
<ul>
<li>If directories isn’t specified when restore, it restores all directories in bucket.</li>
</ul>
<h4 id="Commands"><a href="#Commands" class="headerlink" title="Commands"></a>Commands</h4><p><strong>backup</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">s3backup [<span class="_">-f</span> configuration file] [-v verbose message] [<span class="_">-l</span> path <span class="keyword">for</span> <span class="built_in">log</span>] [-h <span class="built_in">help</span>]</div><div class="line">configuration file  path to file written above contents. default is ./backup.yml</div><div class="line">verbose             display directory tree and difference of anterior backup</div><div class="line">path <span class="keyword">for</span> <span class="built_in">log</span>        defaut starndard output.</div><div class="line"><span class="built_in">help</span>                <span class="built_in">help</span> message</div></pre></td></tr></table></figure>
<p><strong>restore</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">s3backup -r [<span class="_">-f</span> configuration file] [-v verbose message] [<span class="_">-l</span> path <span class="keyword">for</span> <span class="built_in">log</span>] [-o output dir] [-h <span class="built_in">help</span>]</div><div class="line">configuration file  path to file written above contents. default is ./backup.yml</div><div class="line">verbose             display directory tree and difference of anterior backup</div><div class="line">path <span class="keyword">for</span> <span class="built_in">log</span>        defaut starndard output.</div><div class="line">output dir          path to directory <span class="keyword">for</span> restore directory. defaut is .</div><div class="line"><span class="built_in">help</span>                <span class="built_in">help</span> message</div></pre></td></tr></table></figure>

      
    </div>
    <footer class="entry-meta entry-footer">
      
      
  <span class="ico-tags"></span>
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/S3/">S3</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/assets-hosting/">assets hosting</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/rails/">rails</a></li></ul>

      
        
      <section id="comments" class="comment">
        <div id="disqus_thread">
        <noscript>Please enable JavaScript to view the <a href="//disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
        </div>
        </section>

        <script type="text/javascript">
        var disqus_shortname = 'sandeepkrao';
      (function(){
       var dsq = document.createElement('script');
       dsq.type = 'text/javascript';
       dsq.async = true;
       dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
       (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
       }());
      (function(){
       var dsq = document.createElement('script');
       dsq.type = 'text/javascript';
       dsq.async = true;
       dsq.src = '//' + disqus_shortname + '.disqus.com/count.js';
       (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
       }());
      </script>

        

      
    </footer>
  </div>
  
    
<nav id="article-nav">
  
    <a href="/2011/12/09/titanium-passing-parameters-between-windows-how-to-make-things-global/" id="article-nav-newer" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Newer</strong>
      <div class="article-nav-title">
        
          Titanium : Passing parameters between windows [How to make things global]
        
      </div>
    </a>
  
  
    <a href="/2010/10/21/imdbcelebrity-a-new-rubygem-for-parsing-celebritydata-from-www-imdb-com/" id="article-nav-older" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Older</strong>
      <div class="article-nav-title">ImdbCelebrity - A new rubygem for parsing celebritydata from www.imdb.com</div>
    </a>
  
</nav>

  
</article>

<!-- Table of Contents -->

  <aside id="sidebar">
    <div id="toc" class="toc-article">
    <strong class="toc-title">Contents</strong>
    
      <ol class="toc"><li class="toc-item toc-level-3"><a class="toc-link" href="#Database-Backup"><span class="toc-number">1.</span> <span class="toc-text">Database Backup</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Assets-Backup"><span class="toc-number">2.</span> <span class="toc-text">Assets Backup</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#Commands"><span class="toc-number">2.1.</span> <span class="toc-text">Commands</span></a></li></ol></li></ol>
    
    </div>
  </aside>
</section>
        
      </div>
      <footer id="footer" class="site-footer">
  

  <div class="clearfix container">
      <div class="site-info">
	      &copy; 2017 Sandeep Kumar All Rights Reserved.
      </div>
      <div class="site-credit">
        Theme by <a href="https://github.com/iTimeTraveler/hexo-theme-hiero" target="_blank">hiero</a>
      </div>
  </div>
</footer>


<!-- min height -->

<script>
    var wrapdiv = document.getElementById("wrap");
    var contentdiv = document.getElementById("content");

    wrapdiv.style.minHeight = document.body.offsetHeight + "px";
    contentdiv.style.minHeight = document.body.offsetHeight - document.getElementById("allheader").offsetHeight - document.getElementById("footer").offsetHeight + "px";
</script>
    </div>
    <!-- <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
    <a href="/categories" class="mobile-nav-link">Categories</a>
  
    <a href="/tags" class="mobile-nav-link">Tags</a>
  
    <a href="/about" class="mobile-nav-link">About</a>
  
</nav> -->
    
<script>
  var disqus_shortname = 'sandeepkrao';
  
  var disqus_url = 'http://r3bo0t.github.io/2011/02/16/assets-database-hosting-on-amazons3/';
  
  (function(){
    var dsq = document.createElement('script');
    dsq.type = 'text/javascript';
    dsq.async = true;
    dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
  })();
</script>

<div style="display: none;">
  <script src="https://s11.cnzz.com/z_stat.php?id=1260716016&web_id=1260716016" language="JavaScript"></script>
</div>

<!-- mathjax config similar to math.stackexchange -->

<script type="text/x-mathjax-config">
  MathJax.Hub.Config({
    tex2jax: {
      inlineMath: [ ['$','$'], ["\\(","\\)"] ],
      processEscapes: true
    }
  });
</script>

<script type="text/x-mathjax-config">
    MathJax.Hub.Config({
      tex2jax: {
        skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
      }
    });
</script>

<script type="text/x-mathjax-config">
    MathJax.Hub.Queue(function() {
        var all = MathJax.Hub.getAllJax(), i;
        for(i=0; i < all.length; i += 1) {
            all[i].SourceElement().parentNode.className += ' has-jax';
        }
    });
</script>

<script type="text/javascript" src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
</script>


  <link rel="stylesheet" href="/fancybox/jquery.fancybox.css">
  <script src="/fancybox/jquery.fancybox.pack.js"></script>


<script src="/js/script.js"></script>
<script src="/js/bootstrap.js"></script>
<script src="/js/main.js"></script>





  </div>

  <a id="rocket" href="#top" class=""></a>
  <script type="text/javascript" src="/js/totop.js" async=""></script>
  

  <div style="display: none;">
    <script src="https://s95.cnzz.com/z_stat.php?id=1260716016&web_id=1260716016" language="JavaScript"></script>
  </div>


</body>
</html>
